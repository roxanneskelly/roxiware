<div class="book_listing" rel="<%= book_path(book.id)%>" id="<%= book.seo_index %>">
    <a href="<%= book_path(book.seo_index)%>"><img src="<%= book_image_url %>" class="book_cover"/>
    <div class="book_title"><%= book.title %></div></a>
    <% if book_description_length > 0
          book_description = Sanitize.clean(truncate(book.description, 
                                         :length => book_description_length, :omission=>""), Sanitize::Config::RELAXED)
          book_description += "<br/>"+link_to("More...", book_path(book.seo_index)) + "<br/>"
       else
          book_description = book.description
       end 
    %>
    <div class="book_description"><%= raw book_description %></div>

    <br style="clear:both"/>
    <% bookstores = book.get_param("bookstores")
       bookstore_list = []
       if bookstores.present? && bookstores.a.present?
           bookstores.a.each do |bookstore|
	       if bookstore.h.present? && bookstore.h['children'].present? && bookstore.h['children'].a.present? 
	           bookstore_list << bookstore
               end
          end
       end
       if bookstore_list.present? %>
          <div class="bookstore_list">
	     <ul class="book_purchase_bar">
	       <% bookstore_list.each do |bookstore| %>
		   <li class="book_store" id="<%= bookstore.h['store_id'].to_s %>">
		       <% edition = bookstore.h['children'].a[0] %>
		       <a href="<%= edition.h['link'].to_s %>" target="_blank" class="store_name"><%= Roxiware::Book::STORES[bookstore.h['store_id'].conv_value] %></a>
		       <% if bookstore.h['children'].a.length > 1 %>
		           <ul class="book_store_editions">
			       <% bookstore.h['children'].a.each do |edition| %>
			           <li><a href="<%= edition.h['url'].to_s %>" target="_blank" class="edition_store_name"><%= edition.h['name'].to_s %></a></li>
		               <% end %>
		           </ul>
		       <% end %>
	           </li>
	       <% end %>
	   </ul>
         </div>
       <% end %>
</div>
