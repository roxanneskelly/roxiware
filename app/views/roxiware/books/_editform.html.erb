

<style>

.book_edit_form 
{
   margin-top:0.2em;
}

.book_edit_form div.panes > div 
{
    width:40em;
    height:35em;
}

div.book_edit label
{
   width:4em;
}

div.book_edit input#book_title
{
   width:30em;
}

div.book_edit .upload_target
{
   float:right;
   min-width:110px;
   min-height:160px;
   cursor: pointer;
}

textarea#book_description
{
   clear:both;
   height:21em;
   width:52em;
   margin:0px;
   overflow:scroll;
}

div#bookstore_left_pane
{
    margin:0px;
    padding:0px;
    width:15em;
    border:solid 1px #ccc;
    display:inline-block;
    vertical-align:top;
}

div#bookstore_right_pane
{
    margin:0px;
    padding:5px;
    display:inline-block;
    vertical-align:top;
}

div#bookstore_right_pane label
{
   text-align:left;
   width:4em;
}

div#bookstore_right_pane input[name=name]
{
    width:23em;
}
div#bookstore_right_pane input[name=link]
{
    width:23em;
}

div#bookstore_list
{
    width:15em;
    height:25em;
    padding:0px;
    margin:0px;
    overflow:scroll;
}

#import_pane input#import_search
{
   width:43em;
   margin:0.3em 0em 2em 0em;
   
}
#import_pane button#import_search
{
   height:1.7em;
   margin-left: 1em;
   font-size:0.8em;
   line-height:1em;
}

#import_pane button#import_search .ui-button-text 
{
   line-height:1em;
}

.import_watermark
{
   color:grey;
}

#import_search_results
{
   border: solid 1px #ccc;
   overflow: scroll;
   width: 100%;
   height: 23em;
}

#import_search_results .search_result
{
   clear:both;
   padding:5px;
   cursor:pointer;
   text-align:top;
}
#import_search_results .search_result:hover
{
   background:#eeeeff;
}

#import_search_results .book_info
{
   display:inline-block;
   width:28em;
}

#import_search_results .import_links
{
   display:none;
   vertical-align:center;
}

#import_search_results .search_result:hover .import_links
{
   display:inline-block;
}

#import_search_status {
    text-align:center;
    width:100%;
    height:1.5em;
}

#import_search_results .import_links a
{
   display:block;
   padding:0.2em;
}

#import_search_results .import_links a:hover
{
   background:none;
}

#import_search_results .search_result img
{
   float:left;
   margin:5px;
}

#import_search_results .search_result .search_result_title
{
   margin: 10px 0px 5px 0px;
   font-size:1.2em;
   font-weight:700;
}

#import_search_results .search_result .search_result_author
{
   font-size:0.9em
   font-weight:100;
}

a#skip_import
{
   float:right;
   text-align:right;
   margin:5px;
   display:block;
}

</style>
<div class="settings_title">Add Book</div>
<div class="book_edit_form">
  <ul class="tabs">
    <li><a href="#">Import</a></li>
    <li><a href="#">Edit</a></li>
    <li><a href="#">Purchase Settings</a></li>
  </ul>
  <div class="panes">
     <div id="import_pane">
     <a href="#" id="skip_import">Add my book by hand >></a>
     <div class="wizard_step">Import your book.</div>
     <div class="wizard_instructions">Paste or type your book's title, ISBN, or ISBN13 into the search box, or paste in the Goodreads or Amazon link, and we'll find your book.</div>
       <%= search_field_tag(:import_search) %><%= button_tag "Search", :id=>"import_search", :type=>"button", :disabled=>"disabled" %>
     <div id="import_search_status"></div>
     <div id="import_search_results">
     </div>
     </div>
     <div class="book_edit">
	  <%= form_for @book do |book| %>
	           <span class="popup_help_text" style="float:right;">Click to change image</span><br/>
		   <img id="book_image" src="<%= @book.image %>" class="upload_target" upload_sizes="large,medium,small,xsmall,thumbprint"/>
		   <input type="hidden" name="image_thumbprint"/>
		   <div class="wizard_step">Edit your book details.</div>
		   <%= book.hidden_field :image %>
		   <%= book.hidden_field :small_image %>
		   <%= book.label :title, "Title"%>
		   <%= book.text_field :title %>
			   <br/>
		   <%= book.label :isbn, "ISBN"%>
		   <%= book.text_field :isbn %>
			   <br/>
		   <%= book.label :isbn13, "ISBN13" %>
		   <%= book.text_field :isbn13 %>
		   <br style="clear:both"/>

		<%= book.label :description, "Description" %><br/>
		<%= book.text_area :description %>
		<br/>
	     <% end %>
             <%= button_tag "Save", :id=>"save_button", :type=>"button" %>
	 </div>
         <div class="book_purchase_info">
	   <div class="wizard_step">Manage your purchase links</div>
	   <div class="wizard_instructions">You can add(+) or remove(-) links to the various editions (paperbacks, hardbacks, special printings) of your book for each online store.  To add, select the bookstore and push the (+) key.</div>
	   <div>
	      <div id="bookstore_left_pane">
		 <div id="bookstore_list" tabindex=1>

		 </div>
		 <div class="edit_bar">
		     <div id="new_edition" class="edit_bar_button" title="Add an edition">+</div><div id="delete_edition" class="edit_bar_button" title="Remove the edition">-</div>
		 </div>
	      </div>
	      <div id="bookstore_right_pane">
		<label>Name</label><input type="text" name="name" title="The name of your edition (Paperback, Trade Paperback, Hardback, etc."></br>
		<label>Link</label><input type="text" name="link" title="The link to your online edition.  You can get this by finding your book on the online store, copying the link at the top of your browser, and pasting it into the field."></br>
	      </div>
           </div>
           <%= button_tag "Save", :id=>"save_button", :type=>"button" %>
	 </div>
     </div>
</div>
<script>
  <% bookstores = []
     print "STORES: " + @book.get_param("bookstores").inspect + "\n"
     bookstores = @book.get_param("bookstores").a if @book.get_param("bookstores")
     
 %>
  $(function() {

     $("#skip_import").click(function() {
        $(".book_edit_form ul.tabs").data("tabs").next();
     });
     
     $(".book_edit_form textarea").wysiwyg({ css: "<%= stylesheet_path('application') %>",
                                       controls: {
                                          undo: { visible: false },
                                          redo: { visible: false},
                                          insertHorizontalRule: { visible: true},
                                          html: { visible: true},
                                          insertTable: {visible: true},
                                          'fileManager': {
                                              visible: true,
                                              tooltip: "File Manager"
                                                  }
                                           }});

     var import_watermark = 'ISBN, Title, Goodreads Link, Amazon Link';
     $('.book_edit_form input#import_search').blur(function(){
                if ($(this).val().length == 0) {
                   $(this).val(import_watermark).addClass('import_watermark');
                   $(".book_edit_form button#import_search").button("disable");
                  }
                  else {
                  if ($(this).val() != import_watermark)
                      $(".book_edit_form button#import_search").button("enable");
                  }
                }).focus(function(){
                  if ($(this).val() == import_watermark)
                   $(this).val('').removeClass('import_watermark');
                }).val(import_watermark).addClass('import_watermark');

     $('.book_edit_form input#import_search').bind("input propertychange", function() {
        if ($(this).val().length == 0) {
            $(".book_edit_form button#import_search").button("disable");
        }
        else {
            $(".book_edit_form button#import_search").button("enable");
        }
     });
    $('.book_edit_form input#import_search').bind("keypress", function(event) {
         if(event.keyCode == 13) {
           $("button#import_search").click();
         }
    });
     $(".book_edit_form ul.tabs").tabs($("div.panes > div"));
     <% if params[:id] %>
        $(".book_edit_form ul.tabs").data("tabs").next();
     <% end %>
     $(".book_edit_form button").button();

      var bookstore_map = <%= raw bookstores.collect{|bookstore| bookstore.to_jstree_data}.to_json %>
      var jstree = $(".book_edit_form #bookstore_list");
      var stores = <%= raw Roxiware::Book::STORES.to_json %>;
      $(jstree).jstree_param(bookstore_map, {
                             description_guid: "6C16D934-0643-48EC-806C-95BDAF52E078",
                             objects: {
                               "E59B2EB2-6867-475D-A691-ABF1A68E5BE7": { /* bookstore */
                                   valid_children:["4014F256-277D-4B58-8375-E1560524EA20"],
                                   children_guid:"E73E1207-CB64-44AB-8F1C-2032AD6A34B4",
                                   title: function(params) {
                                      return stores[params["store_id"].value];
                                   },
                                   init_params: {
                                   }
                               },
                               "4014F256-277D-4B58-8375-E1560524EA20": { /* edition */
                                   valid_children: "none",
                                   title: "name",
                                   init_params: {
                                      link: {
                                         value: "",
                                         guid:"2BEBB288-5015-4D05-A3A1-224EE4D3D37F"
                                      },
                                      name: {
                                         value: "Paperback",
                                         guid:"89E14824-F9E5-46EA-9A73-584997D972B2"
                                      }
                                   }
                               }
                         }
       });

      $(".book_edit input").bind("change", function () {

        if ($(".book_edit input#book_isbn").val() || $(".book_edit input#book_isbn13").val()) {
            $(".book_edit button#import_button").button("enable");
        }
        else {
            $(".book_edit button#import_button").button("disable");
        }
      });

      $("button#import_search").click(function() {
         var search_val = $("input#import_search").val();
         var endpoint = "<%= import_books_path %>.json?search="+escape(search_val);
         $("#import_search_status").html("Searching...");
         $.getJSON(endpoint,
                   function(data) {
                       $("div#import_search_results").html("");
                       $("#import_search_status").html("Pick your book");
  
                       if(data.length > 0) {
			   $.each(data, function(index, book) {
                              var authors = $("<div class='search_results_authors'></div>");
                              $.each(book['authors'], function(index, author) {
                                  authors.append("<div class='search_result_author'>"+author['author_name']+"</div>");
                              });
			      var book_html = $("<div class='search_result'><div class='book_info'><img src='"+book["small_image"]+"'/>"+
                                                  "<div class='search_result_title'>"+book["title"]+"</div>"+
                                                 authors.html()+
	                                         "<br style='clear:both'/></div>"+
                                                 "<div class='import_links'><a href='#' class='import_and_edit'>import and edit >></a><a href='#' class='import_and_save'>import and save >></a></div></div>");
			      book_html.data().book_data = book;
			      $("div#import_search_results").append(book_html)
			   });
                           $("div#import_search_results .import_and_edit, div#import_search_results .import_and_save").click(function() {
                               var goodreads_id = $(this).parents(".search_result").data().book_data.goodreads_id;
                               var save_after = $(this).is("div#import_search_results .import_and_save");
                               var endpoint = "<%= new_book_path %>.json?goodreads_id="+goodreads_id;
                               $.getJSON(endpoint,
                                  function(data) {
                                     console.log(data);
                                     $(".book_edit input#book_isbn").val(data.isbn);
                                     $(".book_edit input#book_isbn13").val(data.isbn13);
                                     $(".book_edit input#book_title").val(data.title);
                                     $(".book_edit input#book_image").val(data.image);
                                     $(".book_edit input#book_small_image").val(data.small_image);
                                     $(".book_edit img#book_image").attr("src", data.image);
                              
                                     $(".book_edit textarea#book_description").html(data.description);
                                     $(".book_edit_form textarea").wysiwyg("setContent", data.description);
       
                                     $(jstree).jstree_param().reload(data["bookstores[]"]);
                                     if(save_after) {
                                       $(".book_edit_form div.book_edit button#save_button").click();
                                     }
                                     else {
                                        $("ul.tabs").data("tabs").next();
                                     }
                               });
                           });
                       }
                       else {
                          $("div#import_search_status").html("<div class='no_results'>No books found.  Try another ISBN, Title or Link.</div>");
                       }
                    }
                  );
    });
     
  

     $(jstree).bind("select_node.jstree", function(event, data) {
        var currently_selected = $(jstree).jstree("get_selected");
        var type = jQuery.jstree._reference($(jstree))._get_type(currently_selected);
        if(type == "4014F256-277D-4B58-8375-E1560524EA20") {
           $("#bookstore_right_pane input[name=link]").val(currently_selected.data().params.link.value);
           $("#bookstore_right_pane input[name=name]").val(currently_selected.data().params.name.value);
           $("#bookstore_right_pane").css("display", "inline-block");
        }
        else {
          $("#bookstore_right_pane").css("display","none");
        }
      });
      $("#bookstore_right_pane input").bind("change", function() {
         var currently_selected = $(jstree).jstree("get_selected");
         var type = jQuery.jstree._reference($(jstree))._get_type(currently_selected);
         if(type == "4014F256-277D-4B58-8375-E1560524EA20") {
            if($(this).attr("name") == "link") {
               currently_selected.data().params[$(this).attr("name")].value = $(this).val();
            }
            else {
               currently_selected.data().params[$(this).attr("name")].value = $(this).val();
            }
            $(currently_selected).trigger("data_changed.jstree_param");
         }
      });
      $("#bookstore_right_pane input[name=link]").bind("change", function() {
         var currently_selected = $(jstree).jstree("get_selected");
         var type = jQuery.jstree._reference($(jstree))._get_type(currently_selected);
         if(type == "4014F256-277D-4B58-8375-E1560524EA20") {
            currently_selected.data().params[$(this).attr("name")].value = $(this).val();
            $(currently_selected).trigger("data_changed.jstree_param");
         }
      });

      $("#bookstore_left_pane #delete_edition").click(function() {
         var currently_selected = $(jstree).jstree("get_selected");
         if (currently_selected) {
            var type = jQuery.jstree._reference($(jstree))._get_type(currently_selected);
            if(type == "4014F256-277D-4B58-8375-E1560524EA20") {
               $(jstree).jstree("delete_node", currently_selected);
            }
         }
      });

      $("#bookstore_left_pane #new_edition").click(function() {
         var currently_selected = $(jstree).jstree("get_selected");
         var type = jQuery.jstree._reference($(jstree))._get_type(currently_selected);
        if(type == "4014F256-277D-4B58-8375-E1560524EA20") {
           $(jstree).jstree_param().new_node("4014F256-277D-4B58-8375-E1560524EA20", currently_selected, "after");
        }
        else {
           $(jstree).jstree_param().new_node("4014F256-277D-4B58-8375-E1560524EA20", currently_selected, "inside");
        }
      });

      $(".book_edit_form button#save_button").click(function() {
         var xml_result = '<?xml version="1.0" encoding="UTF-8"?><book><params>' +
             $(jstree).jstree_param().export_xml("bookstores") + '</params></book>';
         <% if @book.id.present? %>
	    var endpoint = "<%= book_path(@book.id) %>.xml?" + $(".book_edit_form form").serialize();
	    var method = "PUT";
         <% else %>
	    var endpoint = "<%= books_path %>.xml?" + $(".book_edit_form form").serialize();
            var method="POST";
	 <% end %>
         $.ajax({type:method,
                 processData: false, 
                 contentType: "application/xml",
                 url: endpoint,
                 data:xml_result,
                 success: function() {
                    window.location.reload();
                 }}); 
      });
      

     $(".book_edit_form img.upload_target").bind("click", function() {
      imageDialog({
	     raw_upload: true,
	     onSuccess: function(url, type, thumbprint) {
                 $(".book_edit_form input[name=image]").val(url);
                 $(".book_edit_form input[name=small_image").val(url);
                 $(".book_edit_form img.upload_target").attr("src", url);
             }
      });
    });
   });
</script>
