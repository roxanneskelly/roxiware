<script>
$(function() {
    var csrf_token = $('meta[name="csrf-token"]').attr('content');
    var csrf_param = $('meta[name="csrf-param"]').attr('content');

    /* Manage topic menu is toggled by this button */
    $(".forum_topic .manage_button").click(function(e) {
        var manage_topic_menu = $(this).parent().find(".manage_topic_menu");
        var is_shown = (manage_topic_menu.css("display") != "none");
        $(".manage_topic_menu").css("display", "none");
	$(document).off("click.topicmenu");
        if (!is_shown) {
           manage_topic_menu.css("display", "block");
           e.stopPropagation();
	   $(document).on("click.topicmenu", function() {
	       $(document).off("click.topicmenu");
	       $(".manage_topic_menu").css("display", "none");
	   });
        }
    });

    $(".forum_topic .manage_menu").each(function(index, menu) {
	ddsmoothmenu.init({
	    mainmenuid: $(this).attr("id"),
            rightalign: true,
	    orientation: 'h',
	    classname: 'manage_menu',
	    contentsource: "markup"
	});
    });

    $(".forum_topic li.edit_forum_topic a").click(function() {
       var topic_link = $(this).parents(".forum_topic").attr("rel");
        settingsForm(topic_link+"/edit", "Edit Topic");
    });

    $(".forum_topic li.delete_forum_topic a").click(function() {
       var topic_link = $(this).parents(".forum_topic").attr("rel");
       if(confirm("Remove Topic\nAre you sure?")) {
           $.ajax({url:topic_link,
                   type:"DELETE",
                   dataType: "json",
                   success: function(json_data, textStatus, jqXHR) {
                      window.location.reload();
                   }
            });
        }
    });

    $(".forum_topic .topic_permission a").click(function(e) {
        e.stopPropagation();
        var self = $(this).parent();
        if(self.is(".selected_item")) { return; }
        var topic = self.parents(".forum_topic");
        var upload_params = {forum_topic:{permissions:self.attr("permission")}};
        if (csrf_param !== undefined && csrf_token !== undefined) {
            upload_params[csrf_param] = csrf_token;
        };
       $.ajax($(topic).attr("rel")+".json", {
           type:"PUT",
	   data: upload_params,
           dataType: "json",
	   error: function (jqXHR, textStatus, errorThrown) {
	       $.alert(errorThrown);
           },
           success: function() {
             self.parent().find("li.topic_permission").removeClass("selected_item");
             self.addClass("selected_item");
           }
	});
    });
});
</script>

