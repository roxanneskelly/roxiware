<%= content_tag(:div, :id=>"forum_board_info", :class=>"forum_board_menu_target", :rel=>forum_path(@board.id), :board_permission=>@board.permissions) do 
    link_to("", forum_index_path, :class=>"forum_home_title") +
    content_tag(:div, @board.name, :class=>"forum_board_title") 
end
%>
<%= 
comment_date_format = "%D %l:%M %p"

content_tag(:div, :id=>@board.id, :class=>"forum_board") do 
    content_tag(:div, :class=>"forum_board_header") do 
        content_tag(:div, @board.name, :class=>"forum_board_name") +
        (content_tag(:div, @board.description, :class=>"forum_board_description") if @board.description.present?) +
	content_tag(:div, :class=>"forum_board_counters") do 
	    content_tag(:div, @board.topic_count, :class=>"forum_board_topic_count") +
	    content_tag(:div, @board.post_count, :class=>"forum_board_post_count") +
            (content_tag(:div, @board.pending_post_count, :class=>"forum_board_pending_post_count") if can?(:edit, :@board))
	end 
    end +
    content_tag(:div, :class=>"forum_topics") do
        content_tag(:div, :class=>"forum_topics_header") do 
            content_tag(:div, "", :class=>"forum_topic_info_header") +
            content_tag(:div, "", :class=>"forum_topic_num_posts_header") +
            content_tag(:div, "", :class=>"forum_topic_last_post_header") 
        end +
	@topics.collect do |topic|
            num_new_posts = (@new_post_counts[topic.id] || 0) - 1
            new_post_class=((num_new_posts > 0) || @topics_data[topic.id.to_s].blank? ? "forum_new_posts" : "forum_no_new_posts")
            permissions_class= "topic_permission_"+topic.resolve_comment_permissions 
	    content_tag(:div, :id=>topic.id, :class=>"forum_topic #{new_post_class}", :rel=>forum_update_topic_path(@board.seo_index, topic.id)) do 
		content_tag(:div, :class=>"forum_topic_info") do
	            content_tag(:div, "", :class=>permissions_class+" forum_topic_permissions") +
	            link_to(topic.title, topic.topic_link, :class=>"forum_topic_title") + 
		    (@root_posts[topic.id].comment_author.present? ? link_to(@root_posts[topic.id].comment_author.name, @root_posts[topic.id].comment_author.url, :class=>"forum_topic_author") : content_tag(:div, "Unknown", :class=>"forum_topic_author")) +
		    (content_tag(:div, @root_posts[topic.id].comment_date.localtime.strftime(comment_date_format), :class=>"forum_topic_post_date") if @root_posts[topic.id].present?)
	        end + 
		content_tag(:div, topic.post_count, :class=>"forum_topic_post_count") do
                    content_tag(:span, topic.post_count, :class=>"forum_topic_num_posts") +
                    (content_tag(:span, topic.pending_post_count, :class=>"forum_topic_pending_post_count") if can?(:edit, @board)) +
		    (content_tag(:span, num_new_posts, :class=>"forum_topic_num_new_posts") if num_new_posts > 0) 
                end +
		content_tag(:div, :class=>"forum_topic_last_post forum_topic_menu_target", :topic_permission=>topic.permissions) do
                    if(@last_posts[topic.id].present?)
		        (@last_posts[topic.id].comment_author.present? ? link_to(@last_posts[topic.id].comment_author.name, @last_posts[topic.id].comment_author.url, :class=>"forum_topic_author") : content_tag(:div, "Unknown", :class=>"forum_topic_author")) +
		        content_tag(:div, @last_posts[topic.id].comment_date.localtime.strftime(comment_date_format), :class=>"forum_topic_post_date")
                    end
                end 
	    end
        end.join("").html_safe
    end 
end %>
<% if can? :create_topic, @board %>
    <%= render :partial=>"roxiware/shared/comment_form", :locals=>{:additional_fields=>content_tag(:div, :id=>"comment_form_title") {label_tag(:title) + " " + text_field_tag(:title, "", :watermark=>"Title")}} %>
    <script>
    $(function() {
	initCommentForm("<%= forum_create_topic_path(@board.seo_index) %>.json", 0, "Roxiware::Forum::Topic");
	$(".forum_new_posts").first().prev().each(function(index, object) {
	    $(object)[0].scrollIntoView(true);
	});
    });
    </script>
<% end %>
<% if can? :edit, Roxiware::Forum::Topic %>
<%= render :partial=>"roxiware/forum/topic_manage_control" %>
<% end %>
<% if can? :edit, @board %>
<%= render :partial=>"roxiware/forum/board_manage_control" %>
<% end %>

