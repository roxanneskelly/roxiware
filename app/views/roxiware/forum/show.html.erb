<%= content_tag(:div, :id=>"forum_board_info", :class=>"forum_board_menu_target", :rel=>forum_path(@board.id), :board_permission=>@board.permissions) do 
    link_to("", forum_index_path, :class=>"forum_home_title") +
    content_tag(:div, @board.name, :class=>"forum_board_title") 
end
%>
<%= 
comment_date_format = "%D %l:%M %p"

content_tag(:div, :id=>@board.id, :class=>"forum_board") do 
    content_tag(:div, :class=>"forum_board_header") do 
        content_tag(:div, @board.new_post_count, :class=>(@board.new_post_count > 0) ? "forum_new_posts" : "forum_no_new_posts") +
        content_tag(:div, @board.name, :class=>"forum_board_name") +
        (content_tag(:div, @board.description, :class=>"forum_board_description") if @board.description.present?) +
	content_tag(:div, :class=>"forum_board_counters") do 
	    content_tag(:div, @board.topic_count, :class=>"forum_board_topic_count") +
	    content_tag(:div, @board.post_count, :class=>"forum_board_post_count") +
            (content_tag(:div, @board.pending_post_count, :class=>"forum_board_pending_post_count") if can?(:edit, :@board))
	end 
    end 
    content_tag(:div, :class=>"forum_topics") do
        content_tag(:div, :class=>"forum_topics_header") do 
            content_tag(:div, "", :class=>"forum_topic_permissions_header") +
            content_tag(:div, "", :class=>"forum_topic_info_header") +
            content_tag(:div, "", :class=>"forum_topic_num_posts_header") +
            content_tag(:div, "", :class=>"forum_topic_last_post_header") 
        end +
	@board.topics.visible(current_user).collect do |topic|
            new_post_class=((topic.new_post_count > 0) ? "forum_new_posts" : "forum_no_new_posts")
            permissions_class= "topic_permission_"+topic.resolve_comment_permissions 
	    content_tag(:div, :id=>topic.id, :class=>"forum_topic #{new_post_class}", :rel=>forum_update_topic_path(topic.board.seo_index, topic.id)) do 
	        content_tag(:div, "", :class=>permissions_class+" forum_topic_permissions") +
		content_tag(:div, topic.new_post_count, :class=>"forum_num_new_posts") +
		content_tag(:div, :class=>"forum_topic_info") do
	            link_to(topic.title, topic.topic_link, :class=>"forum_topic_title") + 
		    (topic.root_post.comment_author.present? ? link_to(topic.root_post.comment_author.name, topic.root_post.comment_author.url, :class=>"forum_topic_author") : content_tag(:div, "Unknown", :class=>"forum_topic_author")) +
		    (content_tag(:div, topic.last_post.comment_date.localtime.strftime(comment_date_format), :class=>"forum_topic_post_date") if topic.last_post.present?)
	        end + 
		content_tag(:div, topic.post_count, :class=>"forum_topic_post_count") do
                    content_tag(:span, topic.post_count) +
                    (content_tag(:span, topic.pending_post_count, :class=>"forum_topic_pending_post_count") if can?(:edit, :@board))
                end +
		content_tag(:div, :class=>"forum_topic_last_post forum_topic_menu_target", :topic_permission=>topic.permissions) do
                    if(topic.last_post.present?)
		        (topic.last_post.comment_author.present? ? link_to(topic.last_post.comment_author.name, topic.last_post.comment_author.url, :class=>"forum_topic_author") : content_tag(:div, "Unknown", :class=>"forum_topic_author")) +
		        content_tag(:div, topic.last_post.comment_date.localtime.strftime(comment_date_format), :class=>"forum_topic_post_date")
                    end
                end 
	    end
        end.join("").html_safe
    end 
end %>
<% if can? :create_topic, @board %>
    <%= render :partial=>"roxiware/shared/comment_form", :locals=>{:additional_fields=>content_tag(:div, :id=>"comment_form_title") {label_tag(:title) + " " + text_field_tag(:title, "", :watermark=>"Title")}} %>
    <script>
    $(function() {
	initCommentForm("<%= forum_create_topic_path(@board.seo_index) %>.json", 0, "Roxiware::Forum::Topic");
    });
    </script>
<% end %>
<% if can? :edit, Roxiware::Forum::Topic %>
<%= render :partial=>"roxiware/forum/topic_manage_control" %>
<% end %>
<% if can? :edit, Roxiware::Forum::Board %>
<%= render :partial=>"roxiware/forum/board_manage_control" %>
<% end %>

