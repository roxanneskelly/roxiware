<% layout_section = @page_layout.section(section) %>
<% first_widget = true %>
<% if layout_section.present? && (layout_section.widget_instances.present? || can?(:edit, Roxiware::Layout::WidgetInstance))  %>
  <div id="<%= section %>_section" class="<%= section %>_class">
    <% if can? :edit, @page_layout %>
       <div class="section_name"><%= layout_section.name %>(<%= layout_section.page_layout.controller %>#<%= layout_section.page_layout.action%>)</div>
    <% end %>
    <% layout_section.get_widget_instances.each do |widget_instance| %>
       <% show_widget = true %>
       <% begin %>
         <% locals = widget_instance.get_params %>
         <% globals = widget_instance.globals %>
	 <% show_widget = eval(widget_instance.widget.preload, binding(), widget_instance.widget.name, 1) %>
	 <% if show_widget || can?( :edit, widget_instance) %>
	   <% locals[:widget_instance]=widget_instance %>
	   <% if can? :edit, widget_instance %>
	      <div class="widget_vspace" id="widget-<%= widget_instance.id %>" section="<%= section %>" order="<%= widget_instance.section_order %>"><div></div></div>
	   <% elsif (!first_widget) %>
	      <% first_widget = false %>
	      <div class="widget_vspace"></div>
	   <% end %>
	   <div class="widget" id="widget-<%= widget_instance.id %>" section="<%= section %>" order="<%= widget_instance.section_order %>"
	        <% if widget_instance.get_param("show_background").conv_value %>
	           style="margin:0px;padding:0px;"
                <% end %>
	     >
	     <% if widget_instance.get_param("show_background").conv_value %>
	        <div class="widget_background"></div>
             <% end %>
	     <% if can? :edit, widget_instance %>
		 <div class="widget_drag_box" id="widget-<%= widget_instance.id %>" section="<%= section %>" order="<%= widget_instance.section_order %>"></div>
		 <%= render :partial=>"roxiware/shared/widget_instance_edit_controls", :locals=>{:widget_instance=>widget_instance, :layout_section=>layout_section} %>
	     <% end %>
	     <div class="widget_content">
	       <%= render(:inline => widget_instance.widget.render_view, :locals=>locals ) %>
	    </div>
	  </div>
         <% end %>
       <% rescue Exception => e  %>
	 <div class="widget" id="widget-<%= widget_instance.id %>" section="<%= section %>" order="<%= widget_instance.section_order %>">
           <div class="widget_background"></div>
           <% if can? :edit, widget_instance %>
	       <div class="widget_drag_box" id="widget-<%= widget_instance.id %>" section="<%= section %>" order="<%= widget_instance.section_order %>"></div>
               <%= render :partial=>"roxiware/shared/widget_instance_edit_controls", :locals=>{:widget_instance=>widget_instance, :layout_section=>layout_section} %>
	   <% end %>
	   <div class="widget_exception">
	    <% print "#{widget_instance.widget.name}\n" %>
	    <% print "#{e.message}\n\n\n" %>
	    <% print "LOCALS: #{locals.inspect}\n\n" %>
	    <% print "GLOBALS: #{globals.inspect}\n\n" %>
	    <% print e.backtrace.join("\n") %>
	    <h1>Error in <%= h widget_instance.widget.name %></h1>
	    <pre>
Error in <%= h widget_instance.widget.name %>
<%= h e.message %>:<%= h e.backtrace[0].inspect%>

<%= h widget_instance.widget.preload %>

Locals: <%= h locals.inspect %>

Globals: <%= h globals.inspect %>

<%= h widget_instance.widget.render_view %>


<%= h e.backtrace.join("\n") %></pre>
       </div>
     </div>
     <% end %>
   <% end %>
  <% if can? :edit, Roxiware::Layout::WidgetInstance %>
     <div class="widget_vspace"  section="<%= section %>" order="-1"><div></div></div>
  <% elsif  layout_section.get_widget_instances.present? %>
     <div class="widget_vspace"></div>
  <% end %>
  </div>
<% end %>
