<div class="wizard_instructions">
Make corrections to your book descriptions if needed.<br/>You can always change their descriptons
later.
</div>
<%= form_for(:books, :html=>{:method=>"put", :multipart=>true}) do |books| %>
   <div id="edit_books">
      <div id="book_list">
      </div>
      <div class="edit_bar">
	 <div id="new_book" class="edit_bar_button" title="Add a book">+</div><div id="delete_book" class="edit_bar_button" title="Remove a book">-</div>
      </div>
   </div>
   <div class="book_edit_form">
     <%= fields_for :book do |book_fields|%>
       <%= render :partial=>"roxiware/books/book_edit", :locals=>{:book_fields=>book_fields} %>
     <% end %>
   </div>
   <div class="setup_buttons"><%= button_tag "<< Back", :id=>"back_button", :value=>"back", :type=>"back"%><%= button_tag "Next >>", :id=>"save", :value=>"save", :type=>"button" %></div>
    <%= hidden_field_tag :setup_step, @setup_step %>
    <%= hidden_field_tag :setup_action, "save" %>
<% end %>

<script>
$(function() {

   $.each(<%= raw @books.collect{|book| {:description=>book.description || "", 
                                         :title=>book.title || "",
                                         :isbn=>book.isbn || "", 
                                         :isbn13=>book.isbn13 || "",
                                         :goodreads_id=>book.goodreads_id || "",
                                         :large_image_url=>book.large_image_url || "",
                                         :image_url=>book.image_url || "",
                                         :thumbnail_url=>book.thumbnail_url || ""}}.to_json %>,
           function(index, book) {
               var book_html = $("<div class='book'><img src='"+book.thumbnail_url+"'/><div class='book_details'><div class='book_title'>"+book.title+"</div></div></div>");
               book_html.data().book = book;
               $("div#book_list").append(book_html);
            }); 
   function updateBook(book) {
     $(book).data().book = {
	 title:$(".book_edit_form input#book_title").val(),
	 isbn:$(".book_edit_form input#book_isbn").val(),
	 isbn13:$(".book_edit_form input#book_isbn13").val(),
	 large_image_url:$(".book_edit_form input#book_large_image_url").val(),
	 thumbnail_url:$(".book_edit_form input#book_thumbnail_url").val(),
	 image_url:$(".book_edit_form input#book_image_url").val(),
	 description: $(".book_edit_form textarea#book_description").wysiwyg("getContent")
      }
   }
   

   function updateForm(book) {
      $("textarea#book_description").wysiwyg("setContent", $(book).data().book.description);
      $(".book_edit_form input#book_title").val($(book).data().book.title);
      $(".book_edit_form input#book_isbn").val($(book).data().book.isbn);
      $(".book_edit_form input#book_isbn13").val($(book).data().book.isbn13);
      $(".book_edit_form input#book_image_url").val($(book).data().book.image_url);
      $(".book_edit_form input#book_thumbnail_url").val($(book).data().book.thumbnail_url);
      $(".book_edit_form input#book_large_image_url").val($(book).data().book.large_image_url);
      $(".book_edit_form img#book_image_url").attr("src", $(book).data().book.image_url);
   }
   
   $(".book").click(function() {
      var current_selected_book = $(".book_selected");
      current_selected_book.removeClass("book_selected");
      if((current_selected_book.length != 0) && (!$(this).is(".book_selected"))){
          updateBook(current_selected_book);
      }
      $(this).addClass("book_selected");
      updateForm($(this));
   });

   $(".book_edit_form input").blur(function() {
      var current_selected_book = $(".book_selected");
      if(current_selected_book.length != 0) {
        updateBook(current_selected_book);
      }
   });
   
   $("button#save").click(function() {
      console.log("clicked");
      var current_selected_book = $(".book_selected");
      if(current_selected_book.length != 0) {
        updateBook(current_selected_book);
      }

      console.log("creating xml");
      var xml_data = '<?xml version="1.0" encoding="UTF-8"?><books>';
      $(".book").each(function(index, book_node) {
          book = $(book_node).data().book
          console.log(book);
          var goodreads_id = "";
          if(book["goodreads_id"]) {
             goodreads_id="goodreads_id='"+book.goodreads_id+"'";
          }
          xml_data = xml_data + 
             '<book ' + goodreads_id + ' isbn="'+book.isbn+'" isbn13="' + book.isbn13+'">' +
                 '<title '+goodreads_id+'>'+xmlEscape(book.title)+'</title>' +
                 '<image_url>'+book.image_url+'</image_url>' +
                 '<large_image_url>'+book.large_image_url+'</large_image_url>' +
                 '<thumbnail_url>'+book.thumbnail_url+'</thumbnail_url>' +
                 '<description><![CDATA[ '+ book.description+']]></description>' +
              '</book>';
          console.log("DID DATA");
      });
      xml_data = xml_data + '</books>';

      console.log("XML DATA IS");
      console.log(xml_data);
      var endpoint = "<%= setup_path %>?" + $("form").serialize();

      $.ajax({
          url:"/setup.xml",
          data:xml_data,
          processData:false,
          contentType: "application/xml",
          cache:false,
          type:'PUT',
          success:function() {
             window.location.reload();
          }
      });
   });

   $(".book").first().click();

   $("div#new_book").click(function() {
      var current_selected_book = $(".book_selected");
      if(current_selected_book.length != 0) {
	 var book_id = "new";
	 var book = $("<div class='book' book_id='"+book_id+"'><img src=''/><div class='book_details'><div class='book_title'>Title</div></div></div>");
        current_selected_book.after(book);
	book.click(function() {
	   var current_selected_book = $(".book_selected");
	   current_selected_book.removeClass("book_selected");
	   if((current_selected_book.length != 0) && (!$(this).is(".book_selected"))){
	       updateBook(current_selected_book);
	   }
	   $(this).addClass("book_selected");
	   updateForm($(this));
	});
        book.click();
      }
   });

   $("div#delete_book").click(function() {
      var current_selected_book = $(".book_selected");
      current_selected_book.next().click();
      if(current_selected_book.length != 0) {
	 current_selected_book.remove();
      }
	 
   });
   
   $("input#book_thumbnail_url").change(function() {
      $(".book_selected").find("img").attr("src", $(this).val());
   });

});


</script>
