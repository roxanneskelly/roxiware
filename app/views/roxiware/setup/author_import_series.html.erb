<div class="wizard_instructions">
Looks like you some of your books are in series.  Would you like to import your series information?
</div>
<%= form_for(:series, :html=>{:method=>"put", :multipart=>true}) do |series| %>
   <div id="edit_series">
    <div id="series_list"></div>
    <div class="edit_bar">
       <div id="new_series" class="edit_bar_button" title="Add a series">+</div><div id="delete_series" class="edit_bar_button" title="Remove a series">-</div>
    </div>
   </div>
   <div class="series_edit_form">
     <%= fields_for :series_fields do |series_fields|%>
       <%= render :partial=>"roxiware/books/series/series_edit", :locals=>{:series_fields=>series_fields} %>
     <% end %>
   </div>
   <div class="setup_buttons"><%= button_tag "<< Back", :id=>"back_button", :value=>"back", :type=>"back"%><%= button_tag "Next >>", :id=>"save", :value=>"save", :type=>"button" %></div>
       <%= hidden_field_tag :setup_step, @setup_step %>
       <%= hidden_field_tag :setup_action, "import_series" %>
<% end %>
<script>
$(function() {
    var book_id_map = <%= raw  Hash[@books.collect{|book| [book.goodreads_id, book.id]}].to_json %>;
    $.each(<%= raw @series.to_json %>,
           function(index, series) {
              // add series to series list
              var series_html = $("<div class='series'><img src='"+series.thumbnail_url+"'/><div class='series_details'><div class='series_title'>"+series.title+"</div></div></div>");
              series_html.data().series = series;
              // add book ids for items we think are in the series
              series_html.data().series.book_ids = [];
              $.each(series.books, function(book_index, book) {
                  if(book_id_map[book.id]) {
                    series_html.data().series.book_ids.push(book_id_map[book.id]);
                  }
              });
              $("div#series_list").append(series_html);
              
            });

    function updateSeries(series) {
      var checked_books = [];
      $.each($("input.series_book_checkbox"), function(index, checkbox) {
         console.log("pushing");
         console.log(checkbox);
         if($(checkbox).prop("checked")) {
            checked_books.push($(checkbox).attr("book_id"));
         }
      });
      $(series).data().series = {
	 title:$(".series_edit_form input#series_fields_title").val(),
	 large_image_url:$(".series_edit_form input#series_fields_large_image_url").val(),
	 thumbnail_url:$(".series_edit_form input#series_fields_thumbnail_url").val(),
	 image_url:$(".series_edit_form input#series_fields_image_url").val(),
	 description: $(".series_edit_form textarea#series_fields_description").wysiwyg("getContent"),
         book_ids: checked_books
       }
    }

   function updateForm(series) {
      $("textarea#series_fields_description").wysiwyg("setContent", $(series).data().series.description);
      $(".series_edit_form input#series_fields_title").val($(series).data().series.title);
      $(".series_edit_form input#series_fields_image_url").val($(series).data().series.image_url);
      $(".series_edit_form input#series_fields_thumbnail_url").val($(series).data().series.thumbnail_url);
      $(".series_edit_form input#series_fields_large_image_url").val($(series).data().series.large_image_url);
      $(".series_edit_form img#series_image_url").attr("src", $(series).data().series.image_url);
      $(".series_edit_form input:checkbox").prop("checked", false);
      $.each($(series).data().series.book_ids, function(index, book_id) {
        $(".series_edit_form input#series_fields_include_book_"+book_id).prop("checked", true);
      });
   }

   $(".series").click(function() {
      var current_selected_series = $(".series_selected");
      current_selected_series.removeClass("series_selected");
      if((current_selected_series.length != 0) && (!$(this).is(".series_selected"))){
          updateSeries(current_selected_series);
      }
      $(this).addClass("series_selected");
      updateForm($(this));
   });

   $(".series_edit_form input").blur(function() {
      var current_selected_series = $(".series_selected");
      if(current_selected_series.length != 0) {
        updateSeries(current_selected_series);
      }
   });
   
   $("button#save").click(function() {
      console.log("clicked");
      var current_selected_series = $(".series_selected");
      if(current_selected_series.length != 0) {
        updateSeries(current_selected_series);
      }

      var xml_data = '<?xml version="1.0" encoding="UTF-8"?><series>';
      $(".series").each(function(index, series_node) {
          series = $(series_node).data().series
          console.log(series);
          var goodreads_id = "";
          if(series["goodreads_id"]) {
             goodreads_id="goodreads_id='"+series.goodreads_id+"'";
          }
          var series_books = "<books>";
          for(var book_id in series.book_ids) {
             series_books = series_books + "<book id='"+series.book_ids[book_id]+"' />";
          }
          series_books = series_books + "</books>";
          xml_data = xml_data + 
             '<series ' + goodreads_id +'>' +
                 '<title '+goodreads_id+'>'+xmlEscape(series.title)+'</title>' +
                 '<image_url>'+series.image_url+'</image_url>' +
                 '<large_image_url>'+series.large_image_url+'</large_image_url>' +
                 '<thumbnail_url>'+series.thumbnail_url+'</thumbnail_url>' +
                 '<description><![CDATA[ '+ series.description+']]></description>' +
                 series_books +
              '</series>';
      });
      xml_data = xml_data + '</series>';

      console.log(xml_data);
      var endpoint = "<%= setup_path %>?" + $("form").serialize();

      $.ajax({
          url:"/setup.xml",
          data:xml_data,
          processData:false,
          contentType: "application/xml",
          cache:false,
          type:'PUT',
          success:function() {
             window.location.reload();
          }
      });
   });

   $(".series").first().click();

     $("button#back").click(function() {
        $("input#setup_action").attr($(this).attr("id"));
        $("form").submit();
     });

   $("input#series_fields_thumbnail_url").change(function() {
      $(".series_selected").find("img").attr("src", $(this).val());
   });

});
</script>
