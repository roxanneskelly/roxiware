<?xml version="1.0" encoding="UTF-8"?>
<widgets>
  <widget version="1.0" guid="8BC3E33E-3040-4E21-964A-9F892AD86E6D">
    <name>Menu Widget</name>
    <description>
      <![CDATA[Displays a menu]]>
    </description>
    <editform>
      <![CDATA[<style>

#menu_widget_instance_edit .panes > div
{
  position:absolute;
  top:0px;
  bottom:0px;
  left:0px;
  right:0px;
}

#menu_widget_instance_edit label
{
   width:12em;
}


div.menu_edit 
{
  position:relative;
  width:100%;
  height:100%;
}

#menu_edit_tree
{
    position:absolute;
    left:0;
    top:0;
    bottom:0;
    width:30%;
    vertical-align:top;
}

#menu_edit_right_pane
{
    position:absolute;
    right:0;
    top:0;
    bottom:0;
    width:65%;
    vertical-align:top;
}

#menu_edit_right_pane input[name=url]
{
   width:40%;
}

#menu_edit_right_pane input[name=identifier]
{
   width:40%;
}

#menu_edit_right_pane input[name=name]
{
   width:40%;
}

#menu_edit_right_pane select
{
   width:25%;
}

</style>

<% menu_root = @widget_instance.get_param("menu_root").conv_value %>
<div class="medium_form" id="menu_widget_instance_edit">
   <%= form_tag(layout_page_section_widget_path(@layout.guid, url_encode(@page_layout.get_url_identifier), @layout_section.name, @widget_instance.id), :method=>"put") do%>
   <div class="tab_form">
     <ul class="tabs">
       <li><a href="#">Layout</a></li>
       <li><a href="#">Settings</a></li>
     </ul>
     <div class="panes">
       <div id="menu_layout_pane">
	 <div class="menu_edit">
	    <div id="menu_edit_tree" class="tree_box">
	       <div id="tree_edit"  class="tree_box_content"></div>
	       <div id="menu_item_edit_bar" class="edit_bar"><div id="new_menu_item" class="edit_bar_button">+</div><div id="delete_menu_item" class="edit_bar_button">-</div></div>
	    </div>
	    <div id="menu_edit_right_pane">
	      <%= label_tag :permission, "Permissions" %><%= select_tag :permission, options_for_select({"Guest"=>"guest", "User"=>"user", "Admin"=>"admin", "Super"=>"super"}) %><br/><br/>
              <%= label_tag :name, "Name" %><%= text_field_tag :name %><br/>
              <%= label_tag :identifier, "ID" %><%= text_field_tag :identifier %><br/>
	      <%= label_tag :url, "URL" %><%= text_field_tag :url %><br/>
	    </div>
	  </div>
        </div>
       <div id="settings">
         <%= render :partial=>"roxiware/shared/common_widget_layout_settings" %>
	 <br/>
         <%= fields_for :params, :id=>"params_field" do |params_fields| %>
	     <%= param_field(params_fields, @widget_instance.get_param("show_search_box")) %>
	     <%= param_field(params_fields, @widget_instance.get_param("show_arrow")) %>
	 <% end %>
       </div>
     </div>
    </div>
   <%= button_tag "Save", :id=>"save_button", :class=>"save_button", :type=>"button" %>
   <% end %>
</div>
<script>
   $(function() {
      var menu_map = <%= raw menu_root.collect{|menu_node| menu_node.to_jstree_data}.to_json %>
      var this_jstree = "#menu_widget_instance_edit #tree_edit";

      $("#menu_widget_instance_edit  button#save_button").click(function() {
         var xml_result = '<?xml version="1.0" encoding="UTF-8"?><widget_params>' +
           $(this_jstree).jstree_param().export_xml("menu_root") +
           "</widget_params>";
         var endpoint = "<%= layout_page_section_widget_path(@layout.guid, url_encode(@page_layout.get_url_identifier), @layout_section.name, @widget_instance.id) %>.xml?" + $("#menu_widget_instance_edit form").serialize();
         $.ajax({type:"PUT",
                 processData: false, 
                 contentType: "application/xml",
                 url: endpoint,
                 data:xml_result,
		 error: function(xhr, textStatus, errorThrown) {
		      $.alert(textStatus);
		 },
                 success: function() {
                    window.location.reload();
                 }}); 
      });
      

      $("#menu_widget_instance_edit").find("ul.tabs").tabs($("div.panes > div"));
      $(this_jstree).jstree_param(menu_map,
         { 
             description_guid: "45A433ED-7183-4A28-890B-08F585A0E41A", 
             objects: {
                "FB30B299-B498-4848-AD22-7B973433C9F9": {  /* menu item */
                   children_guid:"457B190F-89DB-42EC-9537-4EBB46498659",
                   title:"name",
                   init_params: {
                           name: {
                             value:"New Menu Item", 
                             guid:"CFBE4135-C0F9-4438-BFBB-6B26EEB365BB"
                           },
                           permission: {
                             value:"guest", 
                             guid:"14E5907E-2C02-413B-8F3B-6C03C2AC9EA1"
                           },
                           url: {
                             value:"/", 
                             guid:"43EE6D21-7BEB-4F45-8105-78ED08A931B0"
                           },
                           identifier: {
                             value:"", 
                             guid:"6AF49BA2-97E3-46FD-A538-9680DEF268D3"
                           }
                   }
                }
             }
         }
     );

     var right_pane = $("#menu_widget_instance_edit  #menu_edit_right_pane");
     right_pane.find("input#url").bind("input blur propertychange",function() {
        var selected_node = $(this_jstree).jstree("get_selected");
        selected_node.data().params[$(this).attr("name")] = {value:$(this).val(), guid:"43EE6D21-7BEB-4F45-8105-78ED08A931B0"};
        $(selected_node).trigger("data_changed.jstree_param");
     });
     right_pane.find("input#identifier").bind("input blur propertychange",function() {
        var selected_node = $(this_jstree).jstree("get_selected");
        selected_node.data().params[$(this).attr("name")] = {value:$(this).val(), guid:"6AF49BA2-97E3-46FD-A538-9680DEF268D3"};
        $(selected_node).trigger("data_changed.jstree_param");
     });
     right_pane.find("select#permission").bind("input blur propertychange change",function() {
        var selected_node = $(this_jstree).jstree("get_selected");
        selected_node.data().params[$(this).attr("name")] = {value:$(this).val(), guid:"14E5907E-2C02-413B-8F3B-6C03C2AC9EA1"};
        $(selected_node).trigger("data_changed.jstree_param");
     });

     $(this_jstree).bind("select_node.jstree", function(event, data) {

        var selected_item = $(this_jstree).jstree("get_selected");
        right_pane.find("input#url").val(selected_item.data().params.url.value);
        right_pane.find("input#name").val(selected_item.data().params.name.value);
        var permission = "guest";
        if(selected_item.data().params.permission) {
           permission = selected_item.data().params.permission;
        }
        right_pane.find("select#permission").val(permission.value);
      });

      $("#menu_widget_instance_edit #delete_menu_item").click(function() {
         var currently_selected = $(this_jstree).jstree("get_selected");
         if (currently_selected) {
            $(this_jstree).jstree("delete_node", currently_selected);
         }
      });
      $("#menu_widget_instance_edit #new_menu_item").click(function() {
         $(this_jstree).jstree_param().new_node("FB30B299-B498-4848-AD22-7B973433C9F9");
      });
      $("#menu_widget_instance_edit").find("button").button();
   });
</script>]]>
    </editform>
    <preload>
      <![CDATA[locals[:menu_root].present?]]>
    </preload>
    <render_view>
      <![CDATA[<% 
         def render_menu(menu_node) 
	  permissions = {"guest"=>0, "user"=>1, "admin"=>2, "super"=>3}
          role = "guest"
          role = current_user.role unless current_user.nil?
          menu_node_values = menu_node.conv_value
          permission = menu_node_values['permission'].to_s
          permission = "guest" unless permissions.has_key?(permission)
          return if(permissions[permission] > permissions[role]) 
          menu_id = menu_node_values['identifier'].to_s
          menu_id = "child_#{menu_node.id}" if menu_id.blank? 
         %>
          <li id="<%= menu_id %>">
	      <% uri = URI.parse(menu_node_values["url"].conv_value) 
	      menu_class = "menu_selected" if ((uri.path == request.path) && ( uri.host.blank? || (uri.host == request.host))) %>
	      <%=  link_to(menu_node_values["url"].conv_value, :class=>menu_class) do %>
                 <%= menu_node_values["name"].conv_value %>
              <% end %>
	    <% if menu_node_values["children"].present? && menu_node_values["children"].conv_value.present? %>
              <ul>
	          <% menu_node_values["children"].conv_value.each do |menu_node_child| 
		     render_menu(menu_node_child)
                  end%>
              </ul>
	    <% end %>
	  </li>
      <% end %>
      <div class="ddsmoothmenu_widget" id="menu-<%= menu_root.id %>">
	<ul id="root_<%= menu_root.id %>">
          <% menu_root.each do |menu_node_child| 
	     render_menu(menu_node_child)
           end%>
	</ul>
      <% if show_search_box %>
	 <%= form_tag(search_path, :method=>"get", :style=>"display:inline-block;") do %>
	    <%= search_field_tag(:query) %>
	 <% end %>
	 <script>
	     $(function() {
		var search_watermark = 'Search';
		$('#login-strip-<%= widget_instance_id %> #query').blur(function(){
		if ($(this).val().length == 0)
		   $(this).val(search_watermark).addClass('search_watermark');
		}).focus(function(){
		  if ($(this).val() == search_watermark)
		   $(this).val('').removeClass('search_watermark');
		}).val(search_watermark).addClass('search_watermark');
	     });
	 </script>
      <% end %>
      </div>
      <script>
	ddsmoothmenu.init({
	   noarrow: <%= show_arrow ?"false":"true" %>,
	   mainmenuid: "menu-<%= menu_root.id %>",
	   orientation: 'h',
	   classname: 'ddsmoothmenu_widget',
	   contentsource: "markup"});
      </script>]]>
    </render_view>
    <style>
      <![CDATA[

.search_watermark
{
   color:grey;
}

div.ddsmoothmenu_widget {
    font: bold 10px Verdana;
    margin-left:auto;
    margin-right:auto;
    height:1.2em;

    form {
       float:right;   
    }

    ul {
	margin-left:auto;
	margin-right:auto;
	z-index:100;
	padding: 0;
	list-style-type: none;
	display: inline-block;

	/*Top level list items*/
	li {
	    display: inline-block;
	    position: relative;
	    padding-left:0px;
	    padding-right:0px;
	    height:20px;
	    vertical-align:middle;
	    text-align:center;
	    line-height:22px;
	    font-weight:bold;

	    /*Top level menu link items style*/
	    a {
		display: block;
		padding-left:10px;
		padding-right:10px;
		text-decoration: none;
		width:auto;

		 /*IE6 hack to get sub menu links to behave correctly*/
		display: inline-block;
	    }

	    /*Top level menu link items style*/
	    div.no_menu_link {
		padding-left:10px;
		padding-right:10px;
	    }

	    /*1st sub level menu*/
	    ul {
		position: absolute;
		left: 0;
		display: none; /*collapse all sub menus to begin with*/
		visibility: hidden;
		width: auto; /*width of sub menus*/

		/* Sub level menu links style */
		li {
		    opacity:0.9;
		    width: 100%; /*width of sub menus*/
		    padding-bottom:0px;
		    display: list-item;
		    margin:0px;
		    height:auto;
		    border:none;

		    a {
			padding-top:5px;
			padding-bottom:5px;
			margin:0px;
		    }

		    /*Top level menu link items style*/
		    span {
			padding:5px;
			line-height:22px;
		    }
		}
		/*All subsequent sub menu levels vertical offset after 1st level sub menu */
		li ul {
		   top: 0;
		}
	    }
	}
    }


    /* Holly Hack for IE \*/
    * html .ddsmoothmenu_widget{height: 1%;} /*Holly Hack for IE7 and below*/


    /* ######### CSS classes applied to down and right arrow images  ######### */

    .downarrowclass {
	position: absolute;
	top: 8px;
	right: 7px;
    }

    .rightarrowclass{
	position: absolute;
	top: 6px;
	right: 5px;
    }

    /* ######### CSS for shadow added to sub menus  ######### */

    .ddshadow{ /*shadow for NON CSS3 capable browsers*/
	position: absolute;
	left: 0;
	top: 0;
	width: 0;
	height: 0;
	background: black;
    }

    .toplevelshadow { /*shadow opacity for NON CSS3 capable browsers. Doesn't work in IE*/
        opacity: 0.8;
    }
}
]]>
    </style>
    <params>
      <param class="local" description="CE9A31B2-4AC7-4C78-82DB-BDC44F3D8D70" name="widget_instance_id"></param>
      <param class="local" description="66966744-BA68-41C6-AC2C-B7B3F2EDE21F" name="show_background">true</param>
      <param class="local" description="5AC29485-DFD2-4D09-B80C-F32F59FF5680" name="show_arrow">true</param>
      <param class="local" description="4DDC51E7-BDBA-4457-B7E1-DF1818DD5793" name="show_search_box">true</param>
      <param class="local" description="45A433ED-7183-4A28-890B-08F585A0E41A" name="menu_root">
        <param class="local" description="FB30B299-B498-4848-AD22-7B973433C9F9" name="child-1">
          <param class="local" description="CFBE4135-C0F9-4438-BFBB-6B26EEB365BB" name="name">Home</param>
          <param class="local" description="43EE6D21-7BEB-4F45-8105-78ED08A931B0" name="url">/</param>
          <param class="local" description="14E5907E-2C02-413B-8F3B-6C03C2AC9EA1" name="permission">guest</param>
          <param class="local" description="457B190F-89DB-42EC-9537-4EBB46498659" name="children">
          </param>
        </param>
        <param class="local" description="FB30B299-B498-4848-AD22-7B973433C9F9" name="child-2">
          <param class="local" description="CFBE4135-C0F9-4438-BFBB-6B26EEB365BB" name="name">Blog</param>
          <param class="local" description="43EE6D21-7BEB-4F45-8105-78ED08A931B0" name="url">/blog</param>
          <param class="local" description="14E5907E-2C02-413B-8F3B-6C03C2AC9EA1" name="permission">guest</param>
        </param>
      </param>
    </params>
  </widget>
  <widget version="1.0" guid="73D15D17-6DB3-46F5-A2B7-6DF1B103617D">
    <name>Content Widget</name>
    <description>
      <![CDATA[Shows generic content]]>
    </description>
    <editform>
      <![CDATA[
<style>
#content_widget_instance_edit {
   padding-top:10px;
}
#content_widget_instance_edit .panes > div {
   padding:2em;
}  
#content_widget_instance_edit label {
   width:30%;
}

#content_widget_instance_edit input {
   width:40%;
}

#content_widget_instance_edit div#content_pane {
    position:absolute;
    left:0;
    right:0;
    top:0;
    bottom:2em;

}
div.settings_wysiwyg {
    width:100%;
    height:100%;
}

</style>
<% page_content = Roxiware::Page.where(:page_type=>widget_instance_id).first || Roxiware::Page.new({:page_type=>widget_instance_id, :content=>"New Content"}, :as=>"") %>
  <%= form_tag(layout_page_section_widget_path(layout.guid, url_encode(page_layout.get_url_identifier()), layout_section.name, widget_instance.id), :method=>"put") do%>

<div class="medium_form" id="content_widget_instance_edit">
   <div class="tab_form">
     <ul class="tabs">
       <li><a>Content</a></li>
       <li><a>Settings</a></li>
     </ul>
     <div class="panes">
       <div id="content_pane">
          <%= fields_for page_content do |page_field_block| %>
	     <div class="settings_wysiwyg"><%= page_field_block.text_area :content %></div>
	  <% end %>
       </div>
       <div id="settings_pane">
          <%= fields_for :params do |param_field_block| %>
              <%= param_fields(param_field_block, widget_instance.get_param_objs.sort{ |l, r| l[0].to_s<=>r[0].to_s }.collect{|param_dup| param_dup[1]}) %>
	  <% end %>
       </div>
     </div>
   </div>
   <%= button_tag "Save", :id=>"save_button", :class=>"save_button", :type=>"button" %>
</div>
<% end %>
<script>
  $(function() {
    $("#content_widget_instance_edit").find("ul.tabs").tabs($("div.panes > div"));
    $("#content_widget_instance_edit  button#save_button").click(function() {
         $.ajax({type:"PUT",
	     processData: false,
             dataType:"json",
	     url: "<%= page_path(page_content.page_type) %>.json",
	     data:jQuery.param($("form").serializeArray()),
	     error: function(xhr, textStatus, errorThrown) {
		  $.alert(textStatus);
	     },
	     success: function() {
		 $.ajax({type:"PUT",
		       processData: false,
		       dataType:"json",
			 url: "<%= layout_page_section_widget_path(@layout.guid, url_encode(@page_layout.get_url_identifier()), @layout_section.name, @widget_instance.id) %>.json",
			 data:jQuery.param($("form").serializeArray()),
			 error: function(xhr, textStatus, errorThrown) {
			      $.alert(textStatus);
			 },
			 success: function() {
                            window.location.reload();
			 }
		     });
		 }
             });
	 });
});
</script>
      ]]>
    </editform>
    <preload><![CDATA[
locals[:page] = Roxiware::Page.where(:page_type=>locals[:widget_instance_id]).first || Roxiware::Page.new({:page_type=>locals[:widget_instance_id], :content=>"New Content"}, :as=>"")
        true]]>
    </preload>
    <render_view>
      <![CDATA[<%= raw page.content %>]]>
    </render_view>
    <style>
      <![CDATA[]]>
    </style>
    <params>
      <param class="local" description="CE9A31B2-4AC7-4C78-82DB-BDC44F3D8D70" name="widget_instance_id"></param>
      <param class="local" description="66966744-BA68-41C6-AC2C-B7B3F2EDE21F" name="show_background">true</param>
    </params>
  </widget>
  <widget version="1.0" guid="FAD1AC80-5580-468C-B4BC-F72A8F6E5F75">
    <name>Javascript Widget</name>
    <description>
      <![CDATA[Javascript]]>
    </description>
    <editform>
      <![CDATA[
<style>
#script_widget_instance_edit {
   padding-top:10px;
}
#script_widget_instance_edit .panes > div {
   padding:2em;
}  
#script_widget_instance_edit label {
   width:30%;
}

#script_widget_instance_edit input {
   width:40%;
}

#script_widget_instance_edit div#content_pane {
    position:absolute;
    left:0;
    right:0;
    top:0;
    bottom:2em;

}
#script_widget_instance_edit textarea {
    position:absolute;
    left:2em;
    right:2em;
    top:2em;
    bottom:4em;
}

</style>
<%  page_content = Roxiware::Page.where(:page_type=>widget_instance_id).first || Roxiware::Page.new({:page_type=>widget_instance_id, :content=>"$(function() {\n});"}, :as=>"") %>
<%= form_tag(layout_page_section_widget_path(layout.guid, url_encode(page_layout.get_url_identifier()), layout_section.name, widget_instance.id), :method=>"put") do%>
   <div class="medium_form" id="script_widget_instance_edit">
      <%= fields_for page_content do |page_field_block| %>
	 <%= page_field_block.text_area :content %>
       <% end %>
      <%= button_tag "Save", :id=>"save_button", :class=>"save_button", :type=>"button" %>
   </div>
<% end %>
<script>
  $(function() {
    $("#script_widget_instance_edit  button#save_button").click(function() {
         $.ajax({type:"PUT",
	     processData: false,
             dataType:"json",
	     url: "<%= page_path(page_content.page_type) %>.json",
	     data:jQuery.param($("form").serializeArray()),
	     error: function(xhr, textStatus, errorThrown) {
		  $.alert(textStatus);
	     },
	     success: function() {
                window.location.reload();
             }
	 });
   });
});
</script>]]>
    </editform>
    <preload>
      <![CDATA[
        locals[:page] = Roxiware::Page.where(:page_type=>locals[:widget_instance_id]).first || Roxiware::Page.new({:page_type=>locals[:widget_instance_id], :content=>"$(function() {\n});"}, :as=>"")
        true]]>
    </preload>
    <render_view>
      <![CDATA[<script><%= raw page.content %></script>]]>
    </render_view>
    <style>
      <![CDATA[
      ]]>
    </style>
    <params>
      <param class="local" description="E69D3C97-40EE-4A3D-91CC-0C1CA0844EAB" name="script_id"></param>
    </params>
  </widget>
  <widget version="1.0" guid="250D3145-7891-41FD-94AA-C64EF7A5801A">
    <name>Recent Posts</name>
    <description>
      <![CDATA[Show recent posts]]>
    </description>
    <editform>
      <![CDATA[]]>
    </editform>
    <preload>
      <![CDATA[if globals[:recent_posts_last_update].blank? || globals[:recent_posts_last_update] < Roxiware::Blog.last_update
	 globals[:recent_posts] = []
	 Roxiware::Blog::Post.published().select("post_title, post_link, post_date, person_id, post_exerpt").order("post_date DESC").limit(locals[:recent_posts_count]).each do |post|
	   globals[:recent_posts] << {:post=>post, :snippet=>truncate(Sanitize.clean(post.post_exerpt), :separator=>' ', :length=>50, :omission=>'')}
	 end
         globals[:recent_posts_last_update] = Roxiware::Blog.last_update
       end
       locals[:recent_posts] = globals[:recent_posts]
       locals[:recent_posts].present?]]>
    </preload>
    <render_view>
      <![CDATA[<nav class="recent_post">
	<div class="recent_post_title">Recent Posts</div>
	<% recent_posts.each do |post_data| 
	   post = post_data[:post] %>
	   <div class="recent_post_entry"><%= link_to post.post_title, post.post_link %>
	     <div class="post_date"><%= post.post_date.localtime.strftime("%D") %>,&nbsp;
		<div class="post_author">
		    <a href="<%= people_url %>/<%= post.person.seo_index %>">
		      <%= post.person.full_name %>
		    </a>
		</div>
	     </div>
	     <div class="post_snippet"><%= post_data[:snippet] %><%= link_to " ...", post.post_link %></div>
	   </div>
	<% end %>
      </nav>]]>
    </render_view>
    <style>
      <![CDATA[div.recent_post_entry
{
   font-size:0.8em;
   margin-top:10px;
}

div.recent_post_entry .post_date
{
   margin-left:10px;
   font-size:0.8em;
}

div.recent_post_entry .post_author
{
   display:inline-block;
}

div.recent_post_entry .post_snippet
{
   margin-left:10px;
   font-size:0.9em;
}]]>
    </style>
    <params>
      <param class="local" description="CE9A31B2-4AC7-4C78-82DB-BDC44F3D8D70" name="widget_instance_id"></param>
      <param class="local" description="66966744-BA68-41C6-AC2C-B7B3F2EDE21F" name="show_background">true</param>
      <param class="local" description="5AD23478-C90D-4BA8-81DF-7112B0762257" name="recent_posts_count">5</param>
    </params>
  </widget>
  <widget version="1.0" guid="2933001C-F5C3-457D-940A-E20B7F9FD69D">
    <name>Category Blog Navigation</name>
    <description>
      <![CDATA[Navigate to blog posts via category]]>
    </description>
    <editform>
      <![CDATA[]]>
    </editform>
    <preload>
      <![CDATA[categories = Roxiware::Terms::Term.categories()

       category_counts = {}
       Roxiware::Terms::TermRelationship.count(:term_id=>categories.keys,
                                               :term_object_id=>Roxiware::Blog::Post.published.map{|post| post.id},
                                               :term_object_type=>"Roxiware::Blog::Post").each do |relationship|
         category_counts[relationship.term_id] ||= 0
         category_counts[relationship.term_id] += 1
       end
       locals[:categories] = categories
       locals[:category_counts] = category_counts
       category_counts.present?]]>
    </preload>
    <render_view>
      <![CDATA[<nav class="categories_nav">
     <div class="category_nav_title">Categories</div>
     <ul>
       <% categories.each do |category_id, category|
         if category_counts[category_id].present? %>
           <li><%= link_to category.name, blog_path(:category=>category.seo_index) %>(<%= category_counts[category_id] %>)</li>
	 <% end %>
       <% end %>
     </ul>
   </nav>]]>
    </render_view>
    <style>
      <![CDATA[]]>
    </style>
    <params>
      <param class="local" description="CE9A31B2-4AC7-4C78-82DB-BDC44F3D8D70" name="widget_instance_id"></param>
      <param class="local" description="66966744-BA68-41C6-AC2C-B7B3F2EDE21F" name="show_background">true</param>
    </params>
  </widget>
  <widget version="1.0" guid="F183DFC0-5A99-45ED-8ECB-D0B61CEC779B">
    <name>Calendar Blog Navigation</name>
    <description>
      <![CDATA[Navigate to blog posts via post date]]>
    </description>
    <editform>
      <![CDATA[]]>
    </editform>
    <preload>
      <![CDATA[if globals[:calendar_posts].blank? || globals[:calendar_nav_last_update].blank? || globals[:calendar_nav_last_update] < Roxiware::Blog.last_update
         puts "LAST UPDATE IS #{Roxiware::Blog.last_update}"
         calendar_posts = {}
         calendar_posts_index = Roxiware::Blog::Post.order("post_date DESC").select("id, post_title, post_date, post_link, post_status")
         published_post_ids = []

         calendar_posts_index.each do |post|
	   year = post.post_date.year
	   calendar_posts[year] ||= {:count=>0, :unpublished_count=>0, :monthly=>{}}
	   calendar_posts[year][:monthly][post.post_date.month] ||= {:count=>0, :unpublished_count=>0, :name=>post.post_date.strftime("%B"), :posts=>[]}
	   calendar_posts[year][:monthly][post.post_date.month][:posts] << {:title=>post.post_title, :published=>(post.post_status == "publish"), :link=>post.post_link}
	   if post.post_status == "publish"
	     calendar_posts[year][:count] += 1
	     calendar_posts[year][:monthly][post.post_date.month][:count] += 1
	     published_post_ids << post.id
	   elsif can? :edit, post
	     calendar_posts[year][:unpublished_count] += 1
	     calendar_posts[year][:monthly][post.post_date.month][:unpublished_count] += 1
	   end
         end
         globals[:calendar_nav_last_update] = Time.now() 
	 globals[:calendar_posts] = calendar_posts
       end
       locals[:calendar_posts] = globals[:calendar_posts]
       locals[:calendar_posts].present?]]>
    </preload>
    <render_view>
      <![CDATA[<nav class="calendar_nav">
    <div class="calendar_nav_title">Archive</div>
    <ul class="calendar_nav_years">
      <% calendar_posts.keys.sort.reverse.each do |year| %>
        <% year_posts = calendar_posts[year] %>
        <li class="calendar_nav_year calendar_nav_hidden"><a>
	    <%= year %> (<%= year_posts[:count]%>)
	      <% if (year_posts[:unpublished_count] > 0) %>
	        <span class="post_unpublished">(<%= year_posts[:unpublished_count] %>)</span>
              <% end %>
	  </a>
	  <ul class="calendar_nav_months">
	    <% year_posts[:monthly].keys.sort.reverse.each do |month| %>
	      <% month_posts = year_posts[:monthly][month] %>
	      <li class="calendar_nav_month calendar_nav_hidden"><a><%= month_posts[:name] %> (<%= month_posts[:count] %>)
                <% if (month_posts[:unpublished_count] > 0) %>
	           <span class="post_unpublished">(<%= month_posts[:unpublished_count] %>)</span>
                 <% end %>
		</a>
	        <ul class="calendar_nav_posts">
		  <% month_posts[:posts].each do |post| %>
                      <li><%= link_to post[:title], post[:link], :class=>post[:published]?"":"post_unpublished" %></li>
		  <% end %>
	        </ul>
	      </li>
	    <% end %>
	  </ul>
        </li>
      <% end %>
    </ul>
  </nav>
  <script>
     $(".calendar_nav li a").click(function(){
       $(this).parent().toggleClass("calendar_nav_hidden");
     });
  </script>]]>
    </render_view>
    <style>
      <![CDATA[li.calendar_nav_year a
{
   cursor:pointer;
}

nav.calendar_nav
{
  padding-left:15px;
}

ul.calendar_nav_posts
{
   list-style-type:none;
   padding: 5px 0px 5px 0px;
}

ul.calendar_nav_posts li
{
   padding: 3px 0px 4px 0px;
}

ul.calendar_nav_months, ul.calendar_nav_years
{
   list-style-type:circle;
   list-style-position:outside;
   padding-left:8px;
   margin:0px;
}

nav.calendar_nav li
{
   font-size:0.9em;
}

nav.calendar_nav li.calendar_nav_year
{
}

nav.calendar_nav li.calendar_nav_months li.calendar_nav_posts
{
}

li.calendar_nav_hidden
{
   list-style-type:disc;
}

li.calendar_nav_hidden ul
{
   display:none;
}]]>
    </style>
    <params>
      <param class="local" description="CE9A31B2-4AC7-4C78-82DB-BDC44F3D8D70" name="widget_instance_id"></param>
      <param class="local" description="66966744-BA68-41C6-AC2C-B7B3F2EDE21F" name="show_background">true</param>
    </params>
  </widget>
  <widget version="1.0" guid="8A7C2B2B-2C57-4408-A699-C4BCABEAD4CA">
    <name>Currently Reading</name>
    <description>
      <![CDATA[Show currently reading from goodreads]]>
    </description>
    <editform>
      <![CDATA[]]>
    </editform>
    <preload>
      <![CDATA[globals[:currently_reading] ||=  {}
        if globals[:currently_reading][:data].blank? || globals[:currently_reading][:refresh_time].blank? || ((globals[:currently_reading][:refresh_time] + locals[:gr_cr_refresh].to_f) < Time.now())
           begin
             goodreads = Roxiware::Goodreads::Review.new(:goodreads_user=>@goodreads_user)
             globals[:currently_reading][:data] = goodreads.list(:sort=>"random", :page=>1, :per_page=>1, :shelf=>"currently-reading")
             globals[:currently_reading][:refresh_time] = Time.now() 
           rescue 
             print "Failure reading goodreads\n"
           end
        end
        locals[:currently_reading] = globals[:currently_reading][:data]
        locals[:currently_reading].present?]]>
    </preload>
    <render_view>
      <![CDATA[<div class="currently_reading">
  <h1>Currently Reading</h1>
  <% if currently_reading.present? %>
  <div class="book" >
     <a type="amzn" search="<%= currently_reading['book']['isbn13']%>" category="books">
       <img border="0" src="<%= currently_reading['book']['image_url'] %>" alt="<%= currently_reading['book']['title']%>"/>
        <div class="book_title"><%= currently_reading['book']['title'] %></div>
     </a>
  </div>
  <% end %>
  <a href="http://www.goodreads.com" style="font-size:0.5em">Data by Goodreads</a>
  <SCRIPT charset="utf-8" type="text/javascript" src="http://ws.amazon.com/widgets/q?ServiceVersion=20070822&MarketPlace=US&ID=<%= @amazon_associate_id %>"> </SCRIPT> <NOSCRIPT><A HREF="http://ws.amazon.com/widgets/q?ServiceVersion=20070822&MarketPlace=US&ID=<%= URI.escape(@amazon_associate_id) %>&Operation=NoScript">Amazon.com Widgets</A></NOSCRIPT>
  </div>]]>
    </render_view>
    <style>
      <![CDATA[]]>
    </style>
    <params>
      <param class="local" description="CE9A31B2-4AC7-4C78-82DB-BDC44F3D8D70" name="widget_instance_id"></param>
      <param class="local" description="66966744-BA68-41C6-AC2C-B7B3F2EDE21F" name="show_background">true</param>
      <param class="local" description="26F42447-4148-4F5F-AAE3-FE3744618E3F" name="gr_cr_refresh">86400</param>
    </params>
  </widget>
  <widget version="1.0" guid="42302934-B3F1-4DED-80C4-B9DF310AC538">
    <name>Featured Books</name>
    <description>
      <![CDATA[Show featured books from goodreads]]>
    </description>
    <editform>
      <![CDATA[]]>
    </editform>
    <preload>
      <![CDATA[globals[:featured_books] ||= {}
        if globals[:featured_books][:data].blank? || globals[:featured_books][:refresh_time].blank? || ((globals[:featured_books][:refresh_time] + locals[:gr_fb_refresh].to_f) < Time.now())
         begin
           goodreads = Roxiware::Goodreads::Review.new(:goodreads_user=>@goodreads_user)
           globals[:featured_books][:data] = goodreads.list(:sort=>"random", :page=>1, :per_page=>locals[:gr_fb_batch]*locals[:gr_fb_count], :shelf=>locals[:featured_shelf])
           globals[:featured_books][:refresh_time] = Time.now() 
         rescue
           print "failure reading goodreads\n"
         end
        end
        locals[:featured_books] = globals[:featured_books][:data]
        locals[:featured_books].present?]]>
    </preload>
    <render_view>
      <![CDATA[<div class="book_ads">
  <h1>Good Books</h1>
  <% if featured_books.present? %>
    <% (0..(gr_fb_count*gr_fb_batch)).collect{|x| x}.shuffle[0..(gr_fb_count-1)].each do |review_index| 
       review = featured_books[review_index] %>
       <div class="book">
	 <a type="amzn" search="<%= review['book']['isbn13']%>" category="books">
	   <img border="0" src="<%= review['book']['image_url'] %>" alt="<%= review['book']['title']%>"/>
	   <div  class="book_title"><%= review['book']['title'] %></div>
	 </a>
       </div>
    <% end %>
  <% end %>
  <a href="http://www.goodreads.com" style="font-size:0.5em">Data by Goodreads</a>
  <SCRIPT charset="utf-8" type="text/javascript" src="http://ws.amazon.com/widgets/q?ServiceVersion=20070822&MarketPlace=US&ID=<%= @amazon_associate_id %>"> </SCRIPT> <NOSCRIPT><A HREF="http://ws.amazon.com/widgets/q?ServiceVersion=20070822&MarketPlace=US&ID=<%= URI.escape(@amazon_associate_id) %>&Operation=NoScript">Amazon.com Widgets</A></NOSCRIPT>
  </div>]]>
    </render_view>
    <style>
      <![CDATA[]]>
    </style>
    <params>
      <param class="local" description="CE9A31B2-4AC7-4C78-82DB-BDC44F3D8D70" name="widget_instance_id"></param>
      <param class="local" description="66966744-BA68-41C6-AC2C-B7B3F2EDE21F" name="show_background">true</param>
      <param class="local" description="536DB435-8652-4457-9374-199635264A81" name="gr_fb_refresh">3600</param>
      <param class="local" description="5CABD8FC-F92C-4DAF-BEE7-0A5299F5DEAD" name="gr_fb_count">2</param>
      <param class="local" description="2E3FAB50-4A5A-4FEE-B6D7-9603A1CA178F" name="gr_fb_batch">20</param>
    </params>
  </widget>
  <widget version="1.0" guid="53A77ACC-5261-49F3-A959-9FB434F43768">
    <name>Events</name>
    <description>
      <![CDATA[Show events]]>
    </description>
    <editform>
      <![CDATA[]]>
    </editform>
    <preload>
      <![CDATA[locals[:events] = Roxiware::Event.where("start >= :start_date", :start_date=>Time.now.utc.midnight).order("start ASC").limit(locals[:events_count])
       locals[:events].present?]]>
    </preload>
    <render_view>
      <![CDATA[
<% if events.present? %>
<nav class="events_widget">
  <%= link_to("Events",events_path, :class=>"events_widget_title") %>
  <% events.each do |event|  %>
    <div id="event-<%= event.id %>" class="event_widget_event">
      <div class="event_widget_date">
	<%= show_time = event.start.strftime("%b %e")
	    if (event.duration_units == "days" && event.duration.present? && event.duration > 1)
	      end_time = event.start + (event.duration.days - 1)
	      show_time = event.start.strftime("%b %e, %Y") unless end_time.year == event.start.year
	      show_time += " - "
	      show_time += end_time.strftime("%b %e, %Y") if event.start.month != end_time.month
	      show_time += end_time.strftime("%e, %Y") if event.start.month == end_time.month
	    end
	    show_time %>
      </div>
      <% if !(event.city.blank? && event.state.blank?) %>
	<div class="event_widget_city">
	  <%= event.city unless event.city.blank? %> 
	  <%= ", " + event.state unless event.state.blank? %>
	</div>
      <% end %>
      <div class="event_widget_location">
        <% if (event.duration_units != "days") || (event.start_time != "12:00 AM") %>
	  <span class="event_widget_start"><%= event.start.strftime("%l:%M %p") %> <%= ", " unless event.location.blank? %></span>
        <% end %>
        <%= event.location %>
      </div>
    </div>
  <% end %>
  <%= link_to("More >", events_path) %>
</nav>
<% end %>      ]]>
    </render_view>
    <style>
      <![CDATA[]]>
    </style>
    <params>
      <param class="local" description="CE9A31B2-4AC7-4C78-82DB-BDC44F3D8D70" name="widget_instance_id"></param>
      <param class="local" description="66966744-BA68-41C6-AC2C-B7B3F2EDE21F" name="show_background">true</param>
      <param class="local" description="6CD4546A-E350-46AC-BAF5-A788047DCD08" name="events_count">3</param>
    </params>
  </widget>
  <widget version="1.0" guid="731793C5-A217-4C5D-9F40-51B23DB4034A">
    <name>Login/Search Strip</name>
    <description>
      <![CDATA[Displays a small strip that has a login link and an  optional search box]]>
    </description>
    <editform>
      <![CDATA[]]>
    </editform>
    <preload>
      <![CDATA[true]]>
    </preload>
    <render_view>
      <![CDATA[<div id="login-strip-<%= widget_instance_id %>" style="display:inline-block;padding-left:10px;padding-right:10px;">
   <% if user_signed_in? %>
      <div id="session-greeting">Welcome <%= current_user.username %>&nbsp;
         <%= link_to_unless_current( "(Log Out)", destroy_session_path('user')) do %>Log&nbsp;Out<% end %>
     </div>
   <% elsif (params[:controller] != "devise/sessions") && (params[:controller] != "devise/passwords") %>
      <div id="session-greeting"><%= link_to(new_session_path('user')) do  %><span>Log&nbsp;In</span><% end %></div>
   <% end %>
   <% if show_search_box %>
      <%= form_tag(search_path, :method=>"get", :style=>"display:inline-block;") do %>
	 <%= search_field_tag(:query) %>
      <% end %>
      <script>
	  $(function() {
	     var search_watermark = 'Search';
	     $('#login-strip-<%= widget_instance_id %> #query').blur(function(){
	     if ($(this).val().length == 0)
		$(this).val(search_watermark).addClass('search_watermark');
	     }).focus(function(){
	       if ($(this).val() == search_watermark)
		$(this).val('').removeClass('search_watermark');
	     }).val(search_watermark).addClass('search_watermark');
	  });
      </script>
   <% end %>
</div>]]>
    </render_view>
    <style>
      <![CDATA[.search_watermark
{
   color:grey;
}
#session-greeting
{
   display:inline-block;
}

#query
{
   display:inline-block;
}]]>
    </style>
    <params>
      <param class="local" description="CE9A31B2-4AC7-4C78-82DB-BDC44F3D8D70" name="widget_instance_id"></param>
      <param class="local" description="66966744-BA68-41C6-AC2C-B7B3F2EDE21F" name="show_background">false</param>
      <param class="local" description="4DDC51E7-BDBA-4457-B7E1-DF1818DD5793" name="show_search_box">true</param>
    </params>
  </widget>
  <widget version="" guid="FF33ED55-E56B-4062-ACE1-0FFE22BB422A">
    <name>Blog Page Navigation</name>
    <description>
      <![CDATA[Displays a list of numbers and next, last for blog posts]]>
    </description>
    <editform>
      <![CDATA[]]>
    </editform>
    <preload>
      <![CDATA[@page.present? && @num_pages.present? && (@num_pages > 1)]]>
    </preload>
    <render_view>
      <![CDATA[<% if @num_pages.blank? %>
	    Blog listing required
	 <% else %>
         <nav class="blog_num_nav">
           <div class="blog_num_nav"><%= link_to("<<", @prev_page_link, :class=>"num_nav_last") if @prev_page_link %></div>
           <% current_page = 1
              page_list_start = @page - nav_width 
              page_list_end = @page + nav_width 
              while(current_page <= @num_pages) do %>
                <div class="blog_num_nav">
		  <% if((current_page == 2) && (page_list_start > 2)) %>
	            <div class="blog_num_nav">&#133;</div>
	          <% current_page = page_list_start
		     end %>
                  <% if current_page != @page %>
		     <%= link_to(current_page.to_s, url_for({:page=>current_page}.merge @link_params)) %>
		  <% else %>
		     <%= current_page.to_s %>
		  <% end %>
		  <% if((current_page == page_list_end) && (current_page < (@num_pages-1))) %>
	               <div class="blog_num_nav">&#133;</div>
	               <% current_page = @num_pages-1
		     end %>
                  <% current_page = current_page + 1 %>
		</div>
             <% end %>
           <div class="blog_num_nav"><%= link_to(">>", @next_page_link, :class=>"num_nav_last") if @next_page_link %></div>
	 </nav>
      <% end %>]]>
    </render_view>
    <style>
      <![CDATA[nav.blog_num_nav div {
   display:inline-block;
}
nav.blog_num_nav 
{
   text-align:center;
   align:center;
   width:100%;
}]]>
    </style>
    <params>
      <param class="local" description="CE9A31B2-4AC7-4C78-82DB-BDC44F3D8D70" name="widget_instance_id"></param>
      <param class="local" description="66966744-BA68-41C6-AC2C-B7B3F2EDE21F" name="show_background">false</param>
      <param class="local" description="84EBE0FB-3C9B-4E13-8D33-4179F593FC6F" name="nav_width">6</param>
    </params>
  </widget>
  <widget version="" guid="367F87CF-2B37-481A-B02E-9918E989BBB7">
    <name>Blog Next/Last Page</name>
    <description>
      <![CDATA[Displays next and last page links for blog posts.]]>
    </description>
    <editform>
      <![CDATA[]]>
    </editform>
    <preload>
      <![CDATA[@prev_page_link.present? || @next_page_link.present?]]>
    </preload>
    <render_view>
      <![CDATA[<nav class="blog_page_nav">
           <div class="blog_page_nav_prev"><%= link_to("<< Previous", @prev_page_link, :class=>"num_nav_prev") if @prev_page_link %></div>
           <div class="blog_page_nav_next"><%= link_to("Next >>", @next_page_link, :class=>"num_nav_next") if @next_page_link %></div>
	   <% if @next_page_link.blank? && @prev_page_link.blank? %>
	      Blog listing required.
	   <% end %>
	 </nav>]]>
    </render_view>
    <style>
      <![CDATA[nav.blog_page_nav {
   text-align:center;
}
nav.blog_page_nav div.blog_page_nav_prev {
   display:inline-block;
   padding-right:20px;
}
nav.blog_page_nav div.blog_page_nav_next 
{
   display:inline-block;
   padding-left:20px;
}]]>
    </style>
    <params>
      <param class="local" description="CE9A31B2-4AC7-4C78-82DB-BDC44F3D8D70" name="widget_instance_id"></param>
      <param class="local" description="66966744-BA68-41C6-AC2C-B7B3F2EDE21F" name="show_background">false</param>
    </params>
  </widget>
</widgets>
